<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Sadman's Air Nav - Waypoints Pro</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; padding:0; font-family:Arial, sans-serif; }
#map { position:absolute; top:0; bottom:0; left:0; right:320px; }
#sidebar { position:absolute; right:0; top:0; bottom:0; width:320px; padding:12px; background:#f7f7f7; overflow:auto; border-left:1px solid #ccc; }
.btn { display:inline-block; padding:6px 10px; margin:3px 2px; background:#2a9df4; color:white; border-radius:4px; text-decoration:none; cursor:pointer; font-size:13px; }
.btn.small { padding:3px 6px; font-size:12px; }
input[type=text], textarea, select { width:100%; box-sizing:border-box; padding:6px; margin:3px 0; }
.waypoint-item { border-bottom:1px dashed #ccc; padding:4px; margin-bottom:4px; }
.waypoint-actions { margin-top:4px; }
.small { font-size:12px; color:#666; }
#speedInput { width:60px; display:inline-block; }
#routeSummary { font-size:12px; margin-top:6px; }
#credit { font-size:12px; font-weight:bold; color:#333; margin-top:12px; text-align:center; }

/* Small screens: sidebar becomes bottom panel */
@media (max-width:800px) {
  #map { right:0; bottom:45%; }
  #sidebar { position:fixed; left:0; right:0; bottom:0; top:auto; height:45%; width:auto; border-left:none; border-top:1px solid #ccc; }
}

/* Overlay for insecure context / instructions */
#insecureOverlay {
  position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.6);
  z-index:9999; display:none; color:#fff; padding:20px; box-sizing:border-box;
}
#insecureOverlay .box { background:#222; padding:16px; border-radius:8px; max-width:720px; margin:auto; }
#insecureOverlay a { color:#ffd; text-decoration:underline; }
</style>
</head>
<body>

<div id="map"></div>

<div id="sidebar">
  <h3>Waypoint Tool</h3>
  <small class="small">Click map to add waypoint. Click waypoint to select/edit.</small>

  <label>Jump to (lat,lon):</label>
  <input id="latIn" placeholder="Latitude" />
  <input id="lonIn" placeholder="Longitude" />
  <a id="goBtn" class="btn">Go/Add</a>

  <h4>Waypoints</h4>
  <div id="list"></div>

  <div>
    <label>Speed (knots for ETA):</label>
    <input id="speedInput" placeholder="kn" type="text"/>
  </div>
  <div style="margin-top:6px;">
    <a id="routeBtn" class="btn">Route selected</a>
    <a id="clearRouteBtn" class="btn" style="background:#999">Clear route</a>
  </div>

  <h4>Flying / Direct-To Modes</h4>
  <a id="startFlyBtn" class="btn">Start Flying Mode</a>
  <a id="stopFlyBtn" class="btn" style="background:#dc3545">Stop Flying Mode</a>
  <a id="startDirectBtn" class="btn" style="background:#6f42c1">Start Direct-To</a>
  <a id="stopDirectBtn" class="btn" style="background:#dc3545">Stop Direct-To</a>
  <a id="recenterBtn" class="btn" style="background:#28a745">Re-center Map</a>

  <h4>Direct-To Waypoint</h4>
  <select id="directSelect"><option value="">Select Waypoint</option></select>

  <h4>Import/Export</h4>
  <a id="saveBtn" class="btn" style="background:#28a745">Save</a>
  <a id="exportBtn" class="btn" style="background:#6c757d">Export JSON</a>
  <a id="importBtn" class="btn" style="background:#ffc107">Import</a>
  <textarea id="jsonArea" rows="4" placeholder="Paste JSON here"></textarea>

  <h4>Coords:</h4>
  <div id="coordsOut" class="small">None</div>
  <div id="routeSummary" class="small"></div>

  <div id="credit">MADE BY LT CDR SADMAN, P NO 3223</div>
</div>

<!-- Overlay shown when insecure context (file:// or plain http) is detected -->
<div id="insecureOverlay" aria-hidden="true">
  <div class="box">
    <h2>Security / Location Notice</h2>
    <p>This page requires secure origin (HTTPS or localhost) for the device's GPS to work properly.
    If you opened this file directly (file://) or over non-secure HTTP, location features will be blocked.</p>
    <p><b>Recommended:</b> Host this file with <b>GitHub Pages</b> (free, HTTPS). See the instructions I provide below.</p>
    <p>If you want to run locally on Android, use a simple HTTP server or an app that serves files over <code>http://localhost</code> (instructions below).</p>
    <p><a id="hideOverlay" class="btn small" style="background:#28a745">I understand - continue anyway</a></p>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/*
  Minimal safe corrections and added checks:
  - Detect insecure context and show overlay with instructions.
  - Use navigator.permissions when available to prompt and give feedback.
  - Better geolocation error handling & messages for mobile devices.
  - Keep all original elements and texts intact.
*/

// show file reference (for debugging)
console.log("Loaded Sadman's Air Nav");

// --- Secure context detection ---
const insecureOverlay = document.getElementById('insecureOverlay');
function checkSecureContextAndWarn(){
  const protocol = window.location.protocol;
  // allow https: and localhost (file:// is not acceptable for geolocation in many browsers)
  const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  const ok = (protocol === 'https:' || isLocalhost);
  if(!ok){
    insecureOverlay.style.display = 'block';
    insecureOverlay.setAttribute('aria-hidden','false');
  }
}
document.getElementById('hideOverlay').onclick = ()=>{
  insecureOverlay.style.display = 'none';
  insecureOverlay.setAttribute('aria-hidden','true');
};
checkSecureContextAndWarn();

// --- Utility functions (unchanged logic) ---
const map = L.map('map').setView([23.685, 90.3563], 7); // Bangladesh
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// existing vars (kept exactly)
let waypoints = [];
let markers = {};
let selected = [];
let routeLayer = null;
let checkpointMarkers = [];
let flyMarker = null;
let flyWatchId = null;
let directLayer = null;
let directTargetId = null;
let lastSpeedGPS = 0;

// --- DOM elements ---
const listDiv = document.getElementById('list');
const coordsOut = document.getElementById('coordsOut');
const routeSummaryDiv = document.getElementById('routeSummary');
const directSelect = document.getElementById('directSelect');
const recenterBtn = document.getElementById('recenterBtn');

// --- Utility functions kept as-is ---
function haversineNM(lat1,lon1,lat2,lon2){
  const R=6371e3, toRad=v=>v*Math.PI/180;
  const œÜ1=toRad(lat1),œÜ2=toRad(lat2),ŒîœÜ=toRad(lat2-lat1),ŒîŒª=toRad(lon2-lon1);
  const a=Math.sin(ŒîœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))/1852; // NM
}
function bearing(lat1,lon1,lat2,lon2){
  const toRad=v=>v*Math.PI/180,toDeg=v=>v*180/Math.PI;
  const œÜ1=toRad(lat1),œÜ2=toRad(lat2),Œª1=toRad(lon1),Œª2=toRad(lon2);
  const y=Math.sin(Œª2-Œª1)*Math.cos(œÜ2);
  const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2-Œª1);
  return (toDeg(Math.atan2(y,x))+360)%360;
}

// --- Waypoint functions (kept) ---
function renderList(){
  listDiv.innerHTML='';
  directSelect.innerHTML='<option value="">Select Waypoint</option>';
  waypoints.forEach(w=>{
    const div=document.createElement('div');
    div.className='waypoint-item';
    div.innerHTML=`
      <b>${w.name}</b><br>
      <span class="small">${w.lat.toFixed(5)}, ${w.lon.toFixed(5)}</span>
      <div class="waypoint-actions">
        <a class="btn small" onclick="editWaypoint(${w.id})">‚úèÔ∏è</a>
        <a class="btn small" style="background:#dc3545" onclick="deleteWaypoint(${w.id})">üóëÔ∏è</a>
        <a class="btn small" style="background:#6f42c1" onclick="selectWaypoint(${w.id})">üéØ</a>
      </div>
    `;
    listDiv.appendChild(div);

    const opt = document.createElement('option');
    opt.value=w.id;
    opt.text=w.name;
    directSelect.appendChild(opt);
  });
}

function addWaypoint(lat,lon,name){
  const id = Date.now()+Math.floor(Math.random()*999);
  const wp={id,lat,lon,name:name||('WP-'+(waypoints.length+1))};
  waypoints.push(wp);
  const marker=L.circleMarker([lat,lon],{radius:6,color:'#f00',fillColor:'#f00',fillOpacity:0.9})
    .addTo(map)
    .bindPopup(`<b>${wp.name}</b><br>${lat.toFixed(5)}, ${lon.toFixed(5)}<br><a href="#" onclick="editWaypoint(${wp.id})">Edit</a>`);
  marker.on('click',()=>selectWaypoint(wp.id));
  markers[id]=marker;
  renderList();
  saveLocal();
}

function editWaypoint(id){
  const wp=waypoints.find(w=>w.id===id);
  if(!wp)return;
  const newName=prompt('Rename waypoint:',wp.name);
  if(newName!==null && newName.trim()!==''){ wp.name=newName.trim(); }
  const newLat=prompt('Change latitude:',wp.lat);
  const newLon=prompt('Change longitude:',wp.lon);
  if(newLat && newLon && !isNaN(newLat) && !isNaN(newLon)){
    wp.lat=parseFloat(newLat); wp.lon=parseFloat(newLon);
    markers[id].setLatLng([wp.lat,wp.lon])
      .bindPopup(`<b>${wp.name}</b><br>${wp.lat.toFixed(5)}, ${wp.lon.toFixed(5)}<br><a href="#" onclick="editWaypoint(${wp.id})">Edit</a>`);
  }
  renderList();
  saveLocal();
}

function deleteWaypoint(id){
  if(!confirm('Delete this waypoint?'))return;
  waypoints=waypoints.filter(w=>w.id!==id);
  map.removeLayer(markers[id]);
  delete markers[id];
  renderList();
  saveLocal();
}

function selectWaypoint(id){
  const idx=selected.indexOf(id);
  if(idx===-1) selected.push(id);
  else selected.splice(idx,1);
  Object.keys(markers).forEach(k=>{
    const mk=markers[k];
    if(selected.includes(Number(k))) mk.setStyle({color:'#00f',fillColor:'#00f'});
    else mk.setStyle({color:'#f00',fillColor:'#f00'});
  });
}

// --- Route & Checkpoints ---
function makeRoute(){
  if(selected.length<2){ alert('Select at least 2 waypoints'); return; }
  if(routeLayer) map.removeLayer(routeLayer);
  checkpointMarkers.forEach(cp=>map.removeLayer(cp));
  checkpointMarkers=[];
  const latlngs=selected.map(id=>{ const w=waypoints.find(wp=>wp.id===id); return [w.lat,w.lon]; });
  routeLayer=L.polyline(latlngs,{color:'#ff6600',weight:2}).addTo(map);

  updateRouteSummary();

  routeLayer.on('click', e => addCheckpoint(e.latlng));
}

function updateRouteSummary(){
  if(selected.length<2) return;
  let cumulativeDistance=0;
  let cumulativeTimeInput=0;
  let cumulativeTimeGPS=0;
  const speedInput=parseFloat(document.getElementById('speedInput').value)||0;
  routeSummaryDiv.innerHTML='';
  for(let i=0;i<selected.length-1;i++){
    const a=waypoints.find(w=>w.id===selected[i]);
    const b=waypoints.find(w=>w.id===selected[i+1]);
    const dist=haversineNM(a.lat,a.lon,b.lat,b.lon);
    cumulativeDistance+=dist;
    const timeInput=speedInput>0 ? (dist/speedInput*60) : 0;
    const timeGPS=lastSpeedGPS>0 ? (dist/lastSpeedGPS*60) : 0;
    cumulativeTimeInput+=timeInput;
    cumulativeTimeGPS+=timeGPS;
    const brg=bearing(a.lat,a.lon,b.lat,b.lon);
    routeSummaryDiv.innerHTML+=`<b>${a.name} ‚Üí ${b.name}</b>: ${dist.toFixed(2)} NM, ${brg.toFixed(1)}¬∞, ETA Input: ${timeInput.toFixed(1)} min, ETA GPS: ${timeGPS.toFixed(1)} min<br>`;
  }
  routeSummaryDiv.innerHTML+=`<b>Total:</b> ${cumulativeDistance.toFixed(2)} NM, ETA Input: ${cumulativeTimeInput.toFixed(1)} min, ETA GPS: ${cumulativeTimeGPS.toFixed(1)} min`;
}

function addCheckpoint(latlng){
  let prevLatLng;
  if(checkpointMarkers.length>0){
    prevLatLng = checkpointMarkers[checkpointMarkers.length-1].getLatLng();
  } else if(selected.length>0){
    const firstWp = waypoints.find(w => w.id===selected[0]);
    prevLatLng = {lat:firstWp.lat, lng:firstWp.lon};
  } else if(flyMarker){
    prevLatLng = flyMarker.getLatLng();
  } else {
    prevLatLng = map.getCenter();
  }

  const dist = haversineNM(prevLatLng.lat, prevLatLng.lng, latlng.lat, latlng.lng);
  const inputSpeed = parseFloat(document.getElementById('speedInput').value) || 0;
  const etaInput = inputSpeed>0 ? (dist/inputSpeed*60).toFixed(1)+' min' : 'N/A';
  const etaGPS = lastSpeedGPS>0 ? (dist/lastSpeedGPS*60).toFixed(1)+' min' : 'N/A';

  const cpMarker = L.circleMarker([latlng.lat, latlng.lng], {
    radius:4,
    color:'#0a0',
    fillColor:'#0a0',
    fillOpacity:0.8
  }).addTo(map);

  cpMarker.bindPopup(`Checkpoint<br>Distance: ${dist.toFixed(2)} NM<br>ETA Input: ${etaInput}<br>ETA GPS: ${etaGPS}`).openPopup();
  cpMarker.bindTooltip(`Dist: ${dist.toFixed(2)} NM, ETA Input: ${etaInput}, ETA GPS: ${etaGPS}`, {permanent:true,direction:'top'});

  checkpointMarkers.push(cpMarker);
}

function clearRoute(){
  if(routeLayer) map.removeLayer(routeLayer);
  routeLayer=null;
  checkpointMarkers.forEach(cp=>map.removeLayer(cp));
  checkpointMarkers=[];
  selected=[];
  routeSummaryDiv.innerHTML='';
  Object.values(markers).forEach(m=>m.setStyle({color:'#f00',fillColor:'#f00'}));
}

// --- Geolocation helpers (ADDED) ---
async function ensureGeolocationPermission(){
  // Returns true if permission is granted or user approves; false otherwise.
  if(!('geolocation' in navigator)) { alert('Geolocation not supported'); return false; }

  // If Permissions API available, query status
  if(navigator.permissions && navigator.permissions.query){
    try{
      const status = await navigator.permissions.query({ name: 'geolocation' });
      // status.state is 'granted', 'prompt', or 'denied'
      console.log('geolocation permission state:', status.state);
      if(status.state === 'granted') return true;
      if(status.state === 'prompt'){
        // Request once with getCurrentPosition to trigger browser prompt
        return new Promise((res) => {
          navigator.geolocation.getCurrentPosition(
            ()=>res(true),
            (err)=> { console.warn('Permission denied or error', err); res(false); },
            { enableHighAccuracy:true, maximumAge:1000, timeout:10000 }
          );
        });
      }
      // denied
      alert('Location permission is denied. Please enable location for this site in your browser settings.');
      return false;
    } catch(e){
      console.warn('Permissions API error', e);
    }
  }
  // Fallback: attempt to get current position to trigger prompt
  return new Promise((res)=>{
    navigator.geolocation.getCurrentPosition(
      ()=>res(true),
      (err)=> { console.warn('Permission denied or error', err); res(false); },
      { enableHighAccuracy:true, maximumAge:1000, timeout:10000 }
    );
  });
}

// --- Flying Mode (modified to use permission helper & improved error handling) ---
function startFlying(){
  if(flyMarker) return alert('Already flying');
  if(!navigator.geolocation) return alert('Geolocation not supported');

  // Ensure secure context
  const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  if(!(location.protocol === 'https:' || isLocalhost)){
    alert('Geolocation requires HTTPS or localhost. Host the file on GitHub Pages or serve it via localhost.');
    return;
  }

  ensureGeolocationPermission().then(ok=>{
    if(!ok) return;
    flyMarker=L.circleMarker([0,0],{radius:6,color:'#a52a2a',fillColor:'#a52a2a',fillOpacity:0.9}).addTo(map);
    flyWatchId=navigator.geolocation.watchPosition(pos=>{
      const lat=pos.coords.latitude;
      const lon=pos.coords.longitude;
      const speed=pos.coords.speed || 0;
      lastSpeedGPS = (speed || 0) * 1.94384; // m/s to knots

      flyMarker.setLatLng([lat,lon]);
      coordsOut.textContent=`${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      map.setView([lat,lon]); // center on flying

      updateRouteSummary();
    },err=>{
      console.error(err);
      alert('Error getting location: '+(err.message||err.code));
    },{enableHighAccuracy:true,maximumAge:1000});
  });
}

function stopFlying(){
  if(flyWatchId) navigator.geolocation.clearWatch(flyWatchId);
  if(flyMarker) map.removeLayer(flyMarker);
  flyMarker=null; flyWatchId=null;
}

// --- Direct-To Mode (modified similarly) ---
function startDirectTo(){
  if(!directSelect.value) return alert('Select waypoint first');
  directTargetId=parseInt(directSelect.value);
  if(!navigator.geolocation) return alert('Geolocation not supported');

  const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  if(!(location.protocol === 'https:' || isLocalhost)){
    alert('Geolocation requires HTTPS or localhost. Host the file on GitHub Pages or serve it via localhost.');
    return;
  }

  ensureGeolocationPermission().then(ok=>{
    if(!ok) return;
    if(directLayer) map.removeLayer(directLayer);
    directLayer=L.polyline([],{color:'#ff00ff',weight:2,dashArray:'4'}).addTo(map);

    if(!flyMarker) {
      flyMarker=L.circleMarker([0,0],{radius:6,color:'#a52a2a',fillColor:'#a52a2a',fillOpacity:0.9}).addTo(map);
    }

    flyWatchId=navigator.geolocation.watchPosition(pos=>{
      const lat=pos.coords.latitude;
      const lon=pos.coords.longitude;
      const speed=pos.coords.speed || 0;
      lastSpeedGPS = (speed || 0) * 1.94384; // m/s to knots

      flyMarker.setLatLng([lat,lon]);
      coordsOut.textContent=`${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      map.setView([lat,lon]); // center

      const target=waypoints.find(w=>w.id===directTargetId);
      if(!target) return;

      const dist=haversineNM(lat,lon,target.lat,target.lon);
      const inputSpeed=parseFloat(document.getElementById('speedInput').value)||0;
      const etaInput=inputSpeed>0 ? (dist/inputSpeed*60).toFixed(1)+' min':'N/A';
      const etaGPS = lastSpeedGPS>0 ? (dist/lastSpeedGPS*60).toFixed(1)+' min' : 'N/A';
      const brg=bearing(lat,lon,target.lat,target.lon);

      routeSummaryDiv.innerHTML=`Direct-To ${target.name}<br>Distance: ${dist.toFixed(2)} NM<br>Bearing: ${brg.toFixed(1)}¬∞<br>ETA Input: ${etaInput}<br>ETA GPS: ${etaGPS}`;

      directLayer.setLatLngs([[lat,lon],[target.lat,target.lon]]);
    },err=>{
      console.error(err);
      alert('Error getting location: '+(err.message||err.code));
    },{enableHighAccuracy:true,maximumAge:1000});
  });
}

function stopDirectTo(){
  if(flyWatchId) navigator.geolocation.clearWatch(flyWatchId);
  if(directLayer) map.removeLayer(directLayer);
  directLayer=null; directTargetId=null;
  routeSummaryDiv.innerHTML='';
  if(flyMarker) map.removeLayer(flyMarker);
  flyMarker=null; flyWatchId=null;
}

// --- Recenter button ---
recenterBtn.onclick = ()=>{
  if(flyMarker){
    map.setView(flyMarker.getLatLng());
  } else {
    alert('Flying or Direct-To mode not active');
  }
}

// --- Local storage ---
function saveLocal(){ localStorage.setItem('map_waypoints_v5',JSON.stringify(waypoints)); }
function loadLocal(){
  const data=localStorage.getItem('map_waypoints_v5');
  if(!data) return;
  try{ const arr=JSON.parse(data); arr.forEach(w=>addWaypoint(w.lat,w.lon,w.name)); }
  catch(e){console.error(e);}
}

// --- Map click ---
map.on('click',e=>{
  coordsOut.textContent=`${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
  addWaypoint(e.latlng.lat,e.latlng.lng);
});

// --- DOM events ---
document.getElementById('goBtn').onclick=()=>{
  const lat=parseFloat(latIn.value),lon=parseFloat(lonIn.value);
  if(isNaN(lat)||isNaN(lon)){alert('Invalid'); return;}
  map.setView([lat,lon],Math.max(map.getZoom(),12));
  addWaypoint(lat,lon,'Manual');
};
document.getElementById('routeBtn').onclick=makeRoute;
document.getElementById('clearRouteBtn').onclick=clearRoute;
document.getElementById('saveBtn').onclick=()=>{ saveLocal(); alert('Saved'); };
document.getElementById('exportBtn').onclick=()=>{
  const blob=new Blob([JSON.stringify(waypoints,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='waypoints.json'; a.click();
};
document.getElementById('importBtn').onclick=()=>{
  try{ const arr=JSON.parse(document.getElementById('jsonArea').value); arr.forEach(w=>addWaypoint(w.lat,w.lon,w.name)); }
  catch(e){alert('Invalid JSON');}
};
document.getElementById('startFlyBtn').onclick=startFlying;
document.getElementById('stopFlyBtn').onclick=stopFlying;
document.getElementById('startDirectBtn').onclick=startDirectTo;
document.getElementById('stopDirectBtn').onclick=stopDirectTo;

// --- INIT ---
loadLocal();
</script>
</body>
</html>
